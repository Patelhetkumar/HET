import subprocess
import yaml
import os
import re

# Load inventory file path
script_dir = os.path.dirname(os.path.abspath(__file__))
inventory_file = os.path.join(script_dir, '..', 'prod', 'inventory.prod.yaml')

def get_efs_server_output():
    """Extracts real-time EFS server details using 'efs display efsserver'."""
    cmd = "efs display efsserver | awk 'NR>3 {print $2 \" \" $1 \" \" $3 \" \" $4}'"
    result = subprocess.run(cmd, shell=True, capture_output=True, text=True, check=True)

    servers = {}
    for line in result.stdout.strip().split("\n"):
        parts = line.strip().split()
        if len(parts) >= 4:
            server_name, domain, host_type, group = parts[:4]
            servers[server_name] = {
                "domain": domain,
                "type": host_type,
                "group": group,
                "cells": set()
            }
    return servers

def load_inventory():
    """Loads inventory data from inventory.prod.yaml."""
    try:
        with open(inventory_file, 'r') as file:
            inventory = yaml.safe_load(file)
    except FileNotFoundError:
        print(f"‚ùå Error: Inventory file '{inventory_file}' not found.")
        return {}, {}

    inventory_servers = {}
    pattern_to_group = {}

    all_groups = inventory.get('all', {}).get('children', {})

    for group, group_data in all_groups.items():
        if not isinstance(group_data, dict):
            continue  

        if "hosts" in group_data and isinstance(group_data["hosts"], dict):
            for server, details in group_data["hosts"].items():
                pattern = re.escape(server.split(".")[0]) + ".*"
                pattern_to_group[pattern] = group  

                if isinstance(details, dict):
                    inventory_servers[server] = {
                        "group": group,
                        "cells": set(details.get("cells", []))
                    }

    return inventory_servers, pattern_to_group

def determine_group_from_pattern(server_name, pattern_to_group):
    """Determine the correct group dynamically based on pattern matching."""
    for pattern, group in pattern_to_group.items():
        if re.match(pattern, server_name):
            return group
    return "NO_MATCH_FOUND"

def extract_efs_cells(server_name):
    """Dynamically generate EFS cell names from server structure."""
    prefix = server_name.split('efs')[0]
    return {
        f"p.{prefix}.ml.com",
        f"d.{prefix}.ml.com"
    }

def compare_efs_with_inventory():
    """Compares EFS database against inventory.prod.yaml dynamically."""
    efs_data = get_efs_server_output()
    inventory_data, pattern_to_group = load_inventory()

    mismatches = []
    outdated_servers = set(inventory_data.keys()) - set(efs_data.keys())
    missing_servers = set(efs_data.keys()) - set(inventory_data.keys())

    if outdated_servers:
        print("\nüö® Outdated (Decommissioned) Servers in Inventory (Not in EFS):")
        print("==========================================================")
        for server in outdated_servers:
            print(f" {server}")

    if missing_servers:
        print("\n‚ö†Ô∏è Servers in EFS but Missing in Inventory:")
        print("==========================================================")
        for server in missing_servers:
            print(f" {server}")

    for server, efs_details in efs_data.items():
        inventory_details = inventory_data.get(server, {})

        expected_group = determine_group_from_pattern(server, pattern_to_group)
        actual_group = efs_details["group"]

        expected_cells = inventory_details.get("cells", set())
        actual_cells = extract_efs_cells(server)

        if expected_group == "NO_MATCH_FOUND" and server in inventory_data:
            expected_group = inventory_data[server]["group"]

        if expected_group == actual_group and expected_cells == actual_cells:
            continue  # Server matches, no mismatch.

        # Ensure proper formatting of sets
        missing_cells = expected_cells - actual_cells
        extra_cells = actual_cells - expected_cells

        mismatch_report = f"\nüîç Mismatch for server: {server}"
        mismatch_report += f"\n - Expected Group (AX Inventory): {expected_group}"
        mismatch_report += f"\n - Actual Group (EFS Database): {actual_group}"
        mismatch_report += f"\n - Efs Database: {sorted(actual_cells)}"
        mismatch_report += f"\n - Ax inventory: {sorted(expected_cells)}"

        if missing_cells:
            mismatch_report += f"\n - Cells in the AX inventory but not in the EFS Database: {sorted(missing_cells)}"
        if extra_cells:
            mismatch_report += f"\n - Cells in the EFS Database but not in the AX inventory: {sorted(extra_cells)}"

        mismatches.append(mismatch_report)

    if mismatches:
        print("\n==== üö® Mismatches Found ====")
        for mismatch in mismatches:
            print(mismatch)
    else:
        print("\n‚úÖ All servers, groups, and cells match between EFS and Inventory!")

# Run Validation
compare_efs_with_inventory()
